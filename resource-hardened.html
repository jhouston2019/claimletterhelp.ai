<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insurance Letter Analysis ‚Äì ClaimLetterHelp (Procedural System)</title>
  <link rel="canonical" href="https://insuranceclaimletterhelp.com/resource.html">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body style="background:#0f172a; color:#fff; font-family:'Inter',sans-serif; padding:20px;">
  
  <!-- CRITICAL SYSTEM IDENTITY WARNING -->
  <div style="background:#7f1d1d; border:3px solid #dc2626; border-radius:12px; padding:1.5rem; margin-bottom:2rem; color:#ffffff;">
    <h2 style="color:#fca5a5; margin:0 0 1rem 0; font-size:1.3rem;">‚ö†Ô∏è SYSTEM LIMITATIONS</h2>
    <p style="margin:0 0 1rem 0; font-weight:600;">This system prepares procedural correspondence only.</p>
    <p style="margin:0 0 0.5rem 0; font-size:0.95rem;">It does NOT:</p>
    <ul style="margin:0; padding-left:1.5rem; font-size:0.9rem; line-height:1.8;">
      <li>Argue, negotiate, or persuade</li>
      <li>Explain beyond what insurer requested</li>
      <li>Provide legal or insurance advice</li>
      <li>Replace attorney representation</li>
      <li>Generate responses for fraud investigations, EUO requests, or attorney involvement</li>
    </ul>
  </div>

  <h1 style="color:#22c55e; margin-bottom:1.5rem;">Procedural Insurance Letter Analysis</h1>
  
  <!-- STEP 1: FILE UPLOAD -->
  <div style="margin-bottom:20px; padding:20px; background:#1e293b; border-radius:8px;">
    <h3 style="color:#22c55e; margin-bottom:15px;">üìÑ Step 1: Upload Letter</h3>
    
    <div style="margin-bottom:15px;">
      <label for="fileUpload" style="display:block; margin-bottom:5px; color:#fff;">Document Upload (PDF, Image)</label>
      <input type="file" id="fileUpload" accept=".pdf,.jpg,.jpeg,.png,image/*" style="width:100%; padding:8px; border-radius:4px; border:1px solid #374151;">
    </div>
    
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="uploadBtn" style="background:#3b82f6; color:#fff; padding:10px 20px; border-radius:6px; border:none; cursor:pointer;">Upload & Extract Text</button>
      <span id="uploadStatus" style="color:#22c55e; font-size:14px;"></span>
    </div>
  </div>

  <!-- STEP 2: CLAIM CLASSIFICATION (MANDATORY) -->
  <div style="margin-bottom:20px; padding:20px; background:#1e293b; border-radius:8px;">
    <h3 style="color:#22c55e; margin-bottom:15px;">üìã Step 2: Claim Classification (Required)</h3>
    
    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; margin-bottom:15px;">
      <div>
        <label style="display:block; margin-bottom:5px; color:#fff; font-weight:bold;">Claim Type:</label>
        <select id="claimType" required style="width:100%; padding:8px; border-radius:4px; border:1px solid #374151; background:#1e293b; color:#fff;">
          <option value="">-- Select Type --</option>
          <option value="property_homeowners">Property - Homeowners</option>
          <option value="property_renters">Property - Renters</option>
          <option value="auto_collision">Auto - Collision</option>
          <option value="auto_comprehensive">Auto - Comprehensive</option>
          <option value="health_medical">Health - Medical</option>
          <option value="health_prescription">Health - Prescription</option>
        </select>
      </div>
      
      <div>
        <label style="display:block; margin-bottom:5px; color:#fff; font-weight:bold;">Party Type:</label>
        <select id="partyType" required style="width:100%; padding:8px; border-radius:4px; border:1px solid #374151; background:#1e293b; color:#fff;">
          <option value="">-- Select Party --</option>
          <option value="first_party">First-Party (Your insurance)</option>
          <option value="third_party">Third-Party (Other's insurance)</option>
        </select>
      </div>
      
      <div>
        <label style="display:block; margin-bottom:5px; color:#fff; font-weight:bold;">Context:</label>
        <select id="claimContext" required style="width:100%; padding:8px; border-radius:4px; border:1px solid #374151; background:#1e293b; color:#fff;">
          <option value="">-- Select Context --</option>
          <option value="personal">Personal</option>
          <option value="commercial">Commercial</option>
        </select>
      </div>
      
      <div>
        <label style="display:block; margin-bottom:5px; color:#fff; font-weight:bold;">Claim Amount:</label>
        <select id="claimAmount" required style="width:100%; padding:8px; border-radius:4px; border:1px solid #374151; background:#1e293b; color:#fff;">
          <option value="">-- Select Amount --</option>
          <option value="under_5k">Under $5,000</option>
          <option value="5k_to_25k">$5,000 - $25,000</option>
          <option value="25k_to_50k">$25,000 - $50,000</option>
          <option value="over_50k">Over $50,000</option>
        </select>
      </div>
    </div>
  </div>

  <!-- STEP 3: SAFETY CONFIRMATIONS (MANDATORY) -->
  <div style="margin-bottom:20px; padding:20px; background:#1e293b; border-radius:8px; border:2px solid #f59e0b;">
    <h3 style="color:#f59e0b; margin-bottom:15px;">‚ö†Ô∏è Step 3: Safety Confirmations (Required)</h3>
    <p style="color:#fff; margin-bottom:15px; font-size:0.9rem;">Check ANY that apply to your letter:</p>
    
    <div style="background:#0f172a; padding:15px; border-radius:6px; border:1px solid #374151;">
      <label style="display:block; margin-bottom:10px; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsFraud" value="fraud" style="margin-right:10px;">
        Letter mentions fraud, misrepresentation, or false statements
      </label>
      <label style="display:block; margin-bottom:10px; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsEUO" value="euo" style="margin-right:10px;">
        Letter requests Examination Under Oath (EUO)
      </label>
      <label style="display:block; margin-bottom:10px; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsRecordedStatement" value="recorded_statement" style="margin-right:10px;">
        Letter requests recorded statement
      </label>
      <label style="display:block; margin-bottom:10px; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsReservation" value="reservation" style="margin-right:10px;">
        Letter states "reservation of rights"
      </label>
      <label style="display:block; margin-bottom:10px; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsAttorney" value="attorney" style="margin-right:10px;">
        Letter mentions attorney, lawyer, or legal counsel
      </label>
      <label style="display:block; margin-bottom:0; cursor:pointer; color:#fff;">
        <input type="checkbox" id="mentionsBadFaith" value="bad_faith" style="margin-right:10px;">
        Letter mentions bad faith or litigation
      </label>
    </div>
    
    <p style="color:#f59e0b; margin-top:15px; font-size:0.85rem; font-style:italic;">
      If you checked ANY box above, this system will likely refuse to generate output and recommend attorney consultation.
    </p>
  </div>

  <!-- OVER-DISCLOSURE WARNING -->
  <div style="background:#fef3c7; border:2px solid #f59e0b; border-radius:8px; padding:1rem; margin-bottom:20px;">
    <p style="margin:0; color:#92400e; font-size:0.95rem; font-weight:600;">
      ‚ö†Ô∏è <strong>OVER-DISCLOSURE WARNING:</strong> This system uses ONLY the letter content and your selections above. 
      Do NOT provide additional narrative, explanations, or stories. Additional information can harm your claim.
    </p>
  </div>
  
  <button id="analyzeBtn" style="background:#22c55e; color:#fff; padding:12px 24px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; margin-bottom:20px; width:100%;">
    Analyze Letter (Procedural System)
  </button>
  
  <!-- Analysis Status -->
  <div id="summaryOutput" style="margin-top:15px; padding:10px; background:#1e293b; border-radius:6px; color:#fff; display:none;"></div>
  
  <!-- Enhanced Analysis Display -->
  <div id="analysisContainer" style="display:none; margin-top:20px; padding:20px; background:#1e293b; border-radius:8px;">
    <h3 style="color:#22c55e; margin-bottom:15px;">üìã Letter Analysis</h3>
    <div id="analysisDetails" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:15px;">
      <!-- Analysis details will be populated here -->
    </div>
  </div>

  <!-- Response Generation Section (Only if safe) -->
  <div id="responseSection" style="display:none; margin-top:20px; padding:20px; background:#1e293b; border-radius:8px;">
    <h3 style="color:#22c55e; margin-bottom:15px;">üìù Generate Procedural Response</h3>
    
    <div style="background:#fef3c7; border:2px solid #f59e0b; border-radius:8px; padding:1rem; margin-bottom:15px;">
      <p style="margin:0; color:#92400e; font-size:0.9rem; font-weight:500;">
        The system will generate a brief, procedural response template. It will NOT argue, negotiate, or explain beyond what the insurer requested.
      </p>
    </div>
    
    <button id="generateBtn" style="background:#3b82f6; color:#fff; padding:12px 24px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; margin-bottom:15px; width:100%;">
      Generate Procedural Response Template
    </button>
    
    <div id="responseStatus" style="margin-bottom:15px; padding:10px; background:#0f172a; border-radius:6px; color:#fff; display:none;"></div>
    
    <div id="responseOutput" style="margin-top:20px; padding:15px; background:#0f172a; border-radius:6px; white-space:pre-wrap; color:#fff; border:1px solid #374151; display:none;"></div>
    
    <div id="downloadSection" style="display:none; margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="pdfBtn" style="background:#dc2626; color:#fff; padding:10px 20px; border-radius:6px; border:none; cursor:pointer; font-weight:bold;">üìÑ Download PDF</button>
      <button id="docxBtn" style="background:#059669; color:#fff; padding:10px 20px; border-radius:6px; border:none; cursor:pointer; font-weight:bold;">üìù Download DOCX</button>
    </div>
  </div>
  
  <!-- Hard Stop Message (If triggered) -->
  <div id="hardStopMessage" style="display:none; margin-top:20px; background:#7f1d1d; border:3px solid #dc2626; border-radius:8px; padding:20px; color:#ffffff;">
    <h3 style="color:#fca5a5; margin:0 0 1rem 0;">‚õî PROFESSIONAL REPRESENTATION REQUIRED</h3>
    <div id="hardStopContent"></div>
  </div>
  
  <p id="confidence" style="margin-top:10px; color:#22c55e; font-weight:bold;"></p>

  <script>
    // SAFETY CRITICAL: DO NOT CALL WITHOUT CLASSIFICATION + PHASE + GUARDRAILS
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    const generateBtn = document.getElementById('generateBtn');
    const summaryOutput = document.getElementById('summaryOutput');
    const responseOutput = document.getElementById('responseOutput');
    const confidence = document.getElementById('confidence');
    const pdfBtn = document.getElementById('pdfBtn');
    const docxBtn = document.getElementById('docxBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const responseStatus = document.getElementById('responseStatus');
    const uploadStatus = document.getElementById('uploadStatus');
    const fileUpload = document.getElementById('fileUpload');
    const analysisContainer = document.getElementById('analysisContainer');
    const analysisDetails = document.getElementById('analysisDetails');
    const responseSection = document.getElementById('responseSection');
    const downloadSection = document.getElementById('downloadSection');
    const hardStopMessage = document.getElementById('hardStopMessage');
    const hardStopContent = document.getElementById('hardStopContent');

    let currentRecordId = null;
    let uploadedFileUrl = null;
    let letterText = '';

    // File upload handler
    uploadBtn.onclick = async () => {
      const file = fileUpload.files[0];
      
      if (!file) {
        uploadStatus.textContent = 'Please select a file to upload.';
        uploadStatus.style.color = '#dc2626';
        return;
      }

      uploadStatus.textContent = 'Processing file...';
      uploadStatus.style.color = '#f59e0b';
      
      try {
        // Convert file to base64 for processing
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFileUrl = e.target.result;
          uploadStatus.textContent = `File ready: ${file.name}`;
          uploadStatus.style.color = '#22c55e';
        };
        reader.readAsDataURL(file);
      } catch (error) {
        uploadStatus.textContent = `Upload error: ${error.message}`;
        uploadStatus.style.color = '#dc2626';
        console.error('Upload error:', error);
      }
    };

    analyzeBtn.onclick = async () => {
      console.log('Analyze button clicked');
      
      // MANDATORY VALIDATION
      const claimType = document.getElementById('claimType').value;
      const partyType = document.getElementById('partyType').value;
      const claimContext = document.getElementById('claimContext').value;
      const claimAmount = document.getElementById('claimAmount').value;
      
      if (!uploadedFileUrl) {
        alert('Please upload a letter file first.');
        return;
      }
      
      if (!claimType || !partyType || !claimContext || !claimAmount) {
        alert('Please complete all required classification fields.');
        return;
      }
      
      // Collect hard-stop indicators
      const hardStopChecks = {
        fraud: document.getElementById('mentionsFraud').checked,
        euo: document.getElementById('mentionsEUO').checked,
        recordedStatement: document.getElementById('mentionsRecordedStatement').checked,
        reservation: document.getElementById('mentionsReservation').checked,
        attorney: document.getElementById('mentionsAttorney').checked,
        badFaith: document.getElementById('mentionsBadFaith').checked
      };
      
      // Check if any hard stop is checked
      const hasHardStop = Object.values(hardStopChecks).some(v => v);
      
      if (hasHardStop) {
        showHardStop({
          message: 'Based on your selections, this letter requires professional attorney representation. This system cannot generate output for this scenario.',
          reasons: [
            'You indicated the letter contains elements that require legal expertise',
            'Self-response in these situations can harm your claim',
            'You must consult an attorney before responding'
          ]
        });
        return;
      }
      
      showStatus('Analyzing letter...');
      
      const classificationData = {
        claimType,
        partyType,
        claimContext,
        claimAmount,
        hardStopChecks
      };

      try {
        // Call hardened analysis endpoint
        const response = await fetch('/.netlify/functions/analyze-insurance-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filePath: uploadedFileUrl,
            fileName: fileUpload.files[0].name,
            classification: classificationData,
            userId: 'user-123' // In production, get from auth
          })
        });
        
        const result = await response.json();
        
        hideStatus();
        
        if (result.hardStop) {
          showHardStop(result.hardStopMessage || {
            message: result.hardStopReason || 'This scenario requires professional representation.',
            reasons: result.riskAssessment?.allMessages || []
          });
        } else {
          displayAnalysisResults(result);
        }
        
      } catch (error) {
        console.error('Analysis error:', error);
        showStatus(`Analysis failed: ${error.message}`);
      }
    };

    function displayAnalysisResults(result) {
      analysisContainer.style.display = 'block';
      
      analysisDetails.innerHTML = `
        <div style="background:#0f172a; padding:15px; border-radius:6px; border-left:4px solid #22c55e;">
          <h4 style="color:#22c55e; margin:0 0 10px 0;">Classification</h4>
          <p style="margin:5px 0; font-size:0.9rem;">Type: ${result.classification.claimType}</p>
          <p style="margin:5px 0; font-size:0.9rem;">Party: ${result.classification.partyType}</p>
          <p style="margin:5px 0; font-size:0.9rem;">Context: ${result.classification.claimContext}</p>
        </div>
        
        <div style="background:#0f172a; padding:15px; border-radius:6px; border-left:4px solid #3b82f6;">
          <h4 style="color:#3b82f6; margin:0 0 10px 0;">Letter Phase</h4>
          <p style="margin:5px 0; font-size:0.9rem;">${result.phase.phase}</p>
          <p style="margin:5px 0; font-size:0.85rem; color:#94a3b8;">${result.phase.reason}</p>
        </div>
        
        <div style="background:#0f172a; padding:15px; border-radius:6px; border-left:4px solid #f59e0b;">
          <h4 style="color:#f59e0b; margin:0 0 10px 0;">Risk Level</h4>
          <p style="margin:5px 0; font-size:0.9rem;">${result.riskAssessment.riskLevel}</p>
          <p style="margin:5px 0; font-size:0.85rem; color:#94a3b8;">Can self-respond: ${result.riskAssessment.allowSelfResponse ? 'Yes' : 'No'}</p>
        </div>
      `;
      
      if (result.analysis) {
        analysisDetails.innerHTML += `
          <div style="background:#0f172a; padding:15px; border-radius:6px; border-left:4px solid #8b5cf6; grid-column:1/-1;">
            <h4 style="color:#8b5cf6; margin:0 0 10px 0;">Analysis</h4>
            <p style="margin:0; font-size:0.9rem; line-height:1.6;">${result.analysis}</p>
          </div>
        `;
      }
      
      currentRecordId = result.recordId;
      
      if (result.riskAssessment.allowSelfResponse) {
        responseSection.style.display = 'block';
      }
    }

    function showHardStop(data) {
      hardStopMessage.style.display = 'block';
      analysisContainer.style.display = 'none';
      responseSection.style.display = 'none';
      
      let content = `<p style="margin:0 0 1rem 0; font-size:1rem;">${data.message}</p>`;
      
      if (data.reasons && data.reasons.length > 0) {
        content += '<ul style="margin:0; padding-left:1.5rem; line-height:1.8;">';
        data.reasons.forEach(reason => {
          content += `<li>${reason}</li>`;
        });
        content += '</ul>';
      }
      
      content += `
        <div style="margin-top:1.5rem; padding:1rem; background:#0f172a; border-radius:6px;">
          <h4 style="color:#fca5a5; margin:0 0 0.5rem 0;">Required Actions:</h4>
          <ol style="margin:0; padding-left:1.5rem; line-height:1.8;">
            <li>Contact an attorney immediately</li>
            <li>Do not respond without professional guidance</li>
            <li>Do not provide statements to insurance company</li>
            <li>Preserve all documentation</li>
          </ol>
        </div>
      `;
      
      hardStopContent.innerHTML = content;
    }

    generateBtn.onclick = async () => {
      if (!currentRecordId) {
        alert('Please analyze the letter first.');
        return;
      }
      
      responseStatus.textContent = 'Generating procedural response...';
      responseStatus.style.display = 'block';
      responseStatus.style.color = '#f59e0b';
      
      try {
        const response = await fetch('/.netlify/functions/generate-insurance-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            recordId: currentRecordId,
            // Additional variables would come from analysis
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.letter) {
          responseOutput.textContent = result.letter;
          responseOutput.style.display = 'block';
          downloadSection.style.display = 'flex';
          responseStatus.textContent = 'Procedural response generated.';
          responseStatus.style.color = '#22c55e';
        } else {
          responseStatus.textContent = `Error: ${result.error || 'Generation failed'}`;
          responseStatus.style.color = '#dc2626';
        }
      } catch (error) {
        responseStatus.textContent = `Generation failed: ${error.message}`;
        responseStatus.style.color = '#dc2626';
      }
    };

    pdfBtn.onclick = async () => {
      const responseText = responseOutput.textContent;
      if (!responseText) {
        alert('No response available for PDF generation.');
        return;
      }
      
      try {
        const res = await fetch('/.netlify/functions/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: responseText,
            fileName: 'Insurance_Response_Letter.pdf'
          })
        });
        
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Insurance_Response_Letter.pdf';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          alert('Error generating PDF.');
        }
      } catch (error) {
        alert('Error generating PDF: ' + error.message);
      }
    };

    docxBtn.onclick = async () => {
      const responseText = responseOutput.textContent;
      if (!responseText) {
        alert('No response available for DOCX generation.');
        return;
      }
      
      try {
        const res = await fetch('/.netlify/functions/generate-docx', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: responseText,
            fileName: 'Insurance_Response_Letter.docx'
          })
        });
        
        if (res.ok) {
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Insurance_Response_Letter.docx';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          alert('Error generating DOCX.');
        }
      } catch (error) {
        alert('Error generating DOCX: ' + error.message);
      }
    };
    
    function showStatus(message) {
      summaryOutput.textContent = message;
      summaryOutput.style.display = 'block';
    }
    
    function hideStatus() {
      summaryOutput.style.display = 'none';
    }
  </script>
</body>
</html>

